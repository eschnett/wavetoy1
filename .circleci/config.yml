version: 2
jobs:
  build:
    docker:
      - image: buildpack-deps:trusty
    steps:
      - checkout
      # Download and unpack the stack executable
      - run:
          command: |
            mkdir -p "$HOME/.local/bin"
            export "PATH=$HOME/.local/bin:$PATH"
            curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C "$HOME/.local/bin" '*/stack'
            curl -L https://github.com/rubik/stack-hpc-coveralls/releases/download/v0.0.4.0/shc-linux-x64-8.0.1.tar.bz2 | tar xj -C "$HOME/.local/bin"
      # Build dependencies
      - run:
          commmand: |
            export "PATH=$HOME/.local/bin:$PATH"
            stack -j2 --no-terminal --install-ghc test --only-dependencies
      # Build the package, its tests, and its docs, and run the
      # tests
      - run:
          command: |
            export "PATH=$HOME/.local/bin:$PATH"
            stack -j2 --no-terminal test --haddock --no-haddock-deps --coverage
      # Collect and submit coverage information
      - run:
          command: |
            export "PATH=$HOME/.local/bin:$PATH"
            shc wavetoy1 wavetoy1-test-suite
    
#   cache_directories:
#     - "~/.stack"
